<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<HTML>
 <HEAD>
   <TITLE> [fellowiki-svncheckins] r7 - pjm trunk/fellowiki/tests/wiki/tests/simple_markup trunk/fellowiki/wiki
   </TITLE>
   <LINK REL="Index" HREF="http://lists.berlios.de/pipermail/fellowiki-svncheckins/2006-March/index.html" >
   <LINK REL="made" HREF="mailto:fellowiki-svncheckins%40lists.berlios.de?Subject=Re%3A%20%5Bfellowiki-svncheckins%5D%20r7%20-%20pjm%20trunk/fellowiki/tests/wiki/tests/simple_markup%20trunk/fellowiki/wiki&In-Reply-To=%3C200603181552.k2IFqoZv015817%40sheep.berlios.de%3E">
   <META NAME="robots" CONTENT="index,nofollow">
   <style type="text/css">
       pre {
           white-space: pre-wrap;       /* css-2.1, curent FF, Opera, Safari */
           }
   </style>
   <META http-equiv="Content-Type" content="text/html; charset=us-ascii">
   <LINK REL="Previous"  HREF="000004.html">
   <LINK REL="Next"  HREF="000006.html">
 </HEAD>
 <BODY BGCOLOR="#ffffff">
   <H1>[fellowiki-svncheckins] r7 - pjm trunk/fellowiki/tests/wiki/tests/simple_markup trunk/fellowiki/wiki</H1>
    <B>fingerle at BerliOS</B> 
    <A HREF="mailto:fellowiki-svncheckins%40lists.berlios.de?Subject=Re%3A%20%5Bfellowiki-svncheckins%5D%20r7%20-%20pjm%20trunk/fellowiki/tests/wiki/tests/simple_markup%20trunk/fellowiki/wiki&In-Reply-To=%3C200603181552.k2IFqoZv015817%40sheep.berlios.de%3E"
       TITLE="[fellowiki-svncheckins] r7 - pjm trunk/fellowiki/tests/wiki/tests/simple_markup trunk/fellowiki/wiki">fingerle at berlios.de
       </A><BR>
    <I>Sat Mar 18 16:52:50 CET 2006</I>
    <P><UL>
        <LI>Previous message: <A HREF="000004.html">[fellowiki-svncheckins] r6 - trunk/fellowiki/tests/wiki
</A></li>
        <LI>Next message: <A HREF="000006.html">[fellowiki-svncheckins] r8 - in trunk/fellowiki: tests/wiki/tests/simple_markup wiki
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5">[ date ]</a>
              <a href="thread.html#5">[ thread ]</a>
              <a href="subject.html#5">[ subject ]</a>
              <a href="author.html#5">[ author ]</a>
         </LI>
       </UL>
    <HR>  
<!--beginarticle-->
<PRE>Author: fingerle
Date: 2006-03-18 16:52:44 +0100 (Sat, 18 Mar 2006)
New Revision: 7

Added:
   pjm/pointers
   trunk/fellowiki/tests/wiki/tests/simple_markup/paragraph.complete.xml
   trunk/fellowiki/tests/wiki/tests/simple_markup/pre_with_non_pre.complete.xml
   trunk/fellowiki/tests/wiki/tests/simple_markup/pre_with_non_pre.wiki
Modified:
   trunk/fellowiki/tests/wiki/tests/simple_markup/escaped_text.complete.xml
   trunk/fellowiki/tests/wiki/tests/simple_markup/just_text.complete.xml
   trunk/fellowiki/tests/wiki/tests/simple_markup/just_text_multiline.complete.xml
   trunk/fellowiki/tests/wiki/tests/simple_markup/line_break.complete.xml
   trunk/fellowiki/tests/wiki/tests/simple_markup/paragraph.wiki
   trunk/fellowiki/tests/wiki/tests/simple_markup/pre.complete.xml
   trunk/fellowiki/tests/wiki/tests/simple_markup/pre.wiki
   trunk/fellowiki/tests/wiki/tests/simple_markup/special_characters.wiki
   trunk/fellowiki/tests/wiki/tests/simple_markup/special_chars.complete.xml
   trunk/fellowiki/wiki/parser.py
Log:
- fixed some test cases for the wiki parser (the test case files and the
  wiki parser as appropriate)
- added pointers file in pjm (pointers to libs that we may want to use)


Added: pjm/pointers
===================================================================
--- pjm/pointers	2006-03-12 11:51:39 UTC (rev 6)
+++ pjm/pointers	2006-03-18 15:52:44 UTC (rev 7)
@@ -0,0 +1,3 @@
+recurring activities: <A HREF="http://projects.amor.org/misc/wiki/Recur">http://projects.amor.org/misc/wiki/Recur</A>
+atom feeds: <A HREF="http://trac.defuze.org/browser/oss/atomixlib">http://trac.defuze.org/browser/oss/atomixlib</A>
+

Modified: trunk/fellowiki/tests/wiki/tests/simple_markup/escaped_text.complete.xml
===================================================================
--- trunk/fellowiki/tests/wiki/tests/simple_markup/escaped_text.complete.xml	2006-03-12 11:51:39 UTC (rev 6)
+++ trunk/fellowiki/tests/wiki/tests/simple_markup/escaped_text.complete.xml	2006-03-18 15:52:44 UTC (rev 7)
@@ -1 +1 @@
-&lt;html xmlns=&quot;<A HREF="http://www.w3.org/1999/xhtml">http://www.w3.org/1999/xhtml</A>&quot;&gt;&lt;head&gt;&lt;title /&gt;&lt;/head&gt;&lt;body&gt;&lt;div class=&quot;parsed-wiki-content&quot;&gt;[%Escaped text. Escaped text. &lt;&amp;&gt; [%Escaped text.%] \Escaped text. Escaped text.%] [%Escaped text.%]&lt;/div&gt;&lt;/body&gt;&lt;/html&gt;
+&lt;html xmlns=&quot;<A HREF="http://www.w3.org/1999/xhtml">http://www.w3.org/1999/xhtml</A>&quot;&gt;&lt;head&gt;&lt;title /&gt;&lt;/head&gt;&lt;body&gt;&lt;div class=&quot;parsed-wiki-content&quot;&gt;&lt;p&gt;[%Escaped text. Escaped text. &lt;&amp;&gt; [%Escaped text.%] \Escaped text. Escaped text.%] [%Escaped text.%]&lt;/p&gt;&lt;/div&gt;&lt;/body&gt;&lt;/html&gt;

Modified: trunk/fellowiki/tests/wiki/tests/simple_markup/just_text.complete.xml
===================================================================
--- trunk/fellowiki/tests/wiki/tests/simple_markup/just_text.complete.xml	2006-03-12 11:51:39 UTC (rev 6)
+++ trunk/fellowiki/tests/wiki/tests/simple_markup/just_text.complete.xml	2006-03-18 15:52:44 UTC (rev 7)
@@ -1 +1 @@
-&lt;html xmlns=&quot;<A HREF="http://www.w3.org/1999/xhtml">http://www.w3.org/1999/xhtml</A>&quot;&gt;&lt;head&gt;&lt;title /&gt;&lt;/head&gt;&lt;body&gt;&lt;div class=&quot;parsed-wiki-content&quot;&gt;Hello World!&lt;/div&gt;&lt;/body&gt;&lt;/html&gt;
\ No newline at end of file
+&lt;html xmlns=&quot;<A HREF="http://www.w3.org/1999/xhtml">http://www.w3.org/1999/xhtml</A>&quot;&gt;&lt;head&gt;&lt;title /&gt;&lt;/head&gt;&lt;body&gt;&lt;div class=&quot;parsed-wiki-content&quot;&gt;&lt;p&gt;Hello World!&lt;/p&gt;&lt;/div&gt;&lt;/body&gt;&lt;/html&gt;

Modified: trunk/fellowiki/tests/wiki/tests/simple_markup/just_text_multiline.complete.xml
===================================================================
--- trunk/fellowiki/tests/wiki/tests/simple_markup/just_text_multiline.complete.xml	2006-03-12 11:51:39 UTC (rev 6)
+++ trunk/fellowiki/tests/wiki/tests/simple_markup/just_text_multiline.complete.xml	2006-03-18 15:52:44 UTC (rev 7)
@@ -1 +1 @@
-&lt;html xmlns=&quot;<A HREF="http://www.w3.org/1999/xhtml">http://www.w3.org/1999/xhtml</A>&quot;&gt;&lt;head&gt;&lt;title /&gt;&lt;/head&gt;&lt;body&gt;&lt;div class=&quot;parsed-wiki-content&quot;&gt;Hello World! Hello World! Hello World! Hello World!&lt;/div&gt;&lt;/body&gt;&lt;/html&gt;
+&lt;html xmlns=&quot;<A HREF="http://www.w3.org/1999/xhtml">http://www.w3.org/1999/xhtml</A>&quot;&gt;&lt;head&gt;&lt;title /&gt;&lt;/head&gt;&lt;body&gt;&lt;div class=&quot;parsed-wiki-content&quot;&gt;&lt;p&gt;Hello World! Hello World! Hello World! Hello World!&lt;/p&gt;&lt;/div&gt;&lt;/body&gt;&lt;/html&gt;

Modified: trunk/fellowiki/tests/wiki/tests/simple_markup/line_break.complete.xml
===================================================================
--- trunk/fellowiki/tests/wiki/tests/simple_markup/line_break.complete.xml	2006-03-12 11:51:39 UTC (rev 6)
+++ trunk/fellowiki/tests/wiki/tests/simple_markup/line_break.complete.xml	2006-03-18 15:52:44 UTC (rev 7)
@@ -1 +1 @@
-&lt;html xmlns=&quot;<A HREF="http://www.w3.org/1999/xhtml">http://www.w3.org/1999/xhtml</A>&quot;&gt;&lt;head&gt;&lt;title /&gt;&lt;/head&gt;&lt;body&gt;&lt;div class=&quot;parsed-wiki-content&quot;&gt;Hello world! %%% Hello world!&lt;br /&gt;Hello world!&lt;br /&gt;Hello world!&lt;/div&gt;&lt;/body&gt;&lt;/html&gt;
+&lt;html xmlns=&quot;<A HREF="http://www.w3.org/1999/xhtml">http://www.w3.org/1999/xhtml</A>&quot;&gt;&lt;head&gt;&lt;title /&gt;&lt;/head&gt;&lt;body&gt;&lt;div class=&quot;parsed-wiki-content&quot;&gt;&lt;p&gt;Hello world! %%% Hello world!&lt;br /&gt;Hello world!&lt;br /&gt;Hello world!&lt;/p&gt;&lt;/div&gt;&lt;/body&gt;&lt;/html&gt;

Added: trunk/fellowiki/tests/wiki/tests/simple_markup/paragraph.complete.xml
===================================================================
--- trunk/fellowiki/tests/wiki/tests/simple_markup/paragraph.complete.xml	2006-03-12 11:51:39 UTC (rev 6)
+++ trunk/fellowiki/tests/wiki/tests/simple_markup/paragraph.complete.xml	2006-03-18 15:52:44 UTC (rev 7)
@@ -0,0 +1 @@
+&lt;html xmlns=&quot;<A HREF="http://www.w3.org/1999/xhtml">http://www.w3.org/1999/xhtml</A>&quot;&gt;&lt;head&gt;&lt;title /&gt;&lt;/head&gt;&lt;body&gt;&lt;div class=&quot;parsed-wiki-content&quot;&gt;&lt;p&gt;paragraph 1&lt;/p&gt;&lt;p&gt;paragraph 2&lt;/p&gt;&lt;/div&gt;&lt;/body&gt;&lt;/html&gt;

Modified: trunk/fellowiki/tests/wiki/tests/simple_markup/paragraph.wiki
===================================================================
--- trunk/fellowiki/tests/wiki/tests/simple_markup/paragraph.wiki	2006-03-12 11:51:39 UTC (rev 6)
+++ trunk/fellowiki/tests/wiki/tests/simple_markup/paragraph.wiki	2006-03-18 15:52:44 UTC (rev 7)
@@ -1,4 +1,4 @@
-paragraph 
+paragraph
 1
 
 paragraph

Modified: trunk/fellowiki/tests/wiki/tests/simple_markup/pre.complete.xml
===================================================================
--- trunk/fellowiki/tests/wiki/tests/simple_markup/pre.complete.xml	2006-03-12 11:51:39 UTC (rev 6)
+++ trunk/fellowiki/tests/wiki/tests/simple_markup/pre.complete.xml	2006-03-18 15:52:44 UTC (rev 7)
@@ -1,4 +1,2 @@
-&lt;html xmlns=&quot;<A HREF="http://www.w3.org/1999/xhtml">http://www.w3.org/1999/xhtml</A>&quot;&gt;&lt;head&gt;&lt;title /&gt;&lt;/head&gt;&lt;body&gt;&lt;div class=&quot;parsed-wiki-content&quot;&gt;[@Preformatted text. &lt;pre&gt;Preformatted text. &lt;&amp;&gt;
-[@Preformatted text.@]
-
-\Preformatted text.&lt;/pre&gt; Preformatted text.@]&lt;/div&gt;&lt;/body&gt;&lt;/html&gt;
+&lt;html xmlns=&quot;<A HREF="http://www.w3.org/1999/xhtml">http://www.w3.org/1999/xhtml</A>&quot;&gt;&lt;head&gt;&lt;title /&gt;&lt;/head&gt;&lt;body&gt;&lt;div class=&quot;parsed-wiki-content&quot;&gt;&lt;pre&gt;Preformatted text. &lt;&amp;&gt;
+Preformatted text.&lt;/pre&gt;&lt;/div&gt;&lt;/body&gt;&lt;/html&gt;

Modified: trunk/fellowiki/tests/wiki/tests/simple_markup/pre.wiki
===================================================================
--- trunk/fellowiki/tests/wiki/tests/simple_markup/pre.wiki	2006-03-12 11:51:39 UTC (rev 6)
+++ trunk/fellowiki/tests/wiki/tests/simple_markup/pre.wiki	2006-03-18 15:52:44 UTC (rev 7)
@@ -1,6 +1,2 @@
-[@Preformatted text.
 [@Preformatted text. &lt;&amp;&gt;
-\[@Preformatted text.\@]
-
-\\\Preformatted text.@]
 Preformatted text.@]

Copied: trunk/fellowiki/tests/wiki/tests/simple_markup/pre_with_non_pre.complete.xml (from rev 4, trunk/fellowiki/tests/wiki/tests/simple_markup/pre.complete.xml)
===================================================================
--- trunk/fellowiki/tests/wiki/tests/simple_markup/pre.complete.xml	2006-03-11 00:34:25 UTC (rev 4)
+++ trunk/fellowiki/tests/wiki/tests/simple_markup/pre_with_non_pre.complete.xml	2006-03-18 15:52:44 UTC (rev 7)
@@ -0,0 +1,4 @@
+&lt;html xmlns=&quot;<A HREF="http://www.w3.org/1999/xhtml">http://www.w3.org/1999/xhtml</A>&quot;&gt;&lt;head&gt;&lt;title /&gt;&lt;/head&gt;&lt;body&gt;&lt;div class=&quot;parsed-wiki-content&quot;&gt;&lt;p&gt;[@Preformatted text. &lt;/p&gt;&lt;pre&gt;Preformatted text. &lt;&amp;&gt;
+[@Preformatted text.@]
+
+\Preformatted text.&lt;/pre&gt;&lt;p&gt; Preformatted text.@]&lt;/p&gt;&lt;/div&gt;&lt;/body&gt;&lt;/html&gt;

Copied: trunk/fellowiki/tests/wiki/tests/simple_markup/pre_with_non_pre.wiki (from rev 4, trunk/fellowiki/tests/wiki/tests/simple_markup/pre.wiki)

Modified: trunk/fellowiki/tests/wiki/tests/simple_markup/special_characters.wiki
===================================================================
--- trunk/fellowiki/tests/wiki/tests/simple_markup/special_characters.wiki	2006-03-12 11:51:39 UTC (rev 6)
+++ trunk/fellowiki/tests/wiki/tests/simple_markup/special_characters.wiki	2006-03-18 15:52:44 UTC (rev 7)
@@ -1 +1,8 @@
-TODO: n-dash, m-dash
+n--dash
+n --dash
+n-- dash
+n -- dash
+m---dash
+m ---dash
+m--- dash
+m --- dash

Modified: trunk/fellowiki/tests/wiki/tests/simple_markup/special_chars.complete.xml
===================================================================
--- trunk/fellowiki/tests/wiki/tests/simple_markup/special_chars.complete.xml	2006-03-12 11:51:39 UTC (rev 6)
+++ trunk/fellowiki/tests/wiki/tests/simple_markup/special_chars.complete.xml	2006-03-18 15:52:44 UTC (rev 7)
@@ -1 +1 @@
-&lt;html xmlns=&quot;<A HREF="http://www.w3.org/1999/xhtml">http://www.w3.org/1999/xhtml</A>&quot;&gt;&lt;head&gt;&lt;title /&gt;&lt;/head&gt;&lt;body&gt;&lt;div class=&quot;parsed-wiki-content&quot;&gt;&lt;&amp;&gt;&lt;/div&gt;&lt;/body&gt;&lt;/html&gt;
\ No newline at end of file
+&lt;html xmlns=&quot;<A HREF="http://www.w3.org/1999/xhtml">http://www.w3.org/1999/xhtml</A>&quot;&gt;&lt;head&gt;&lt;title /&gt;&lt;/head&gt;&lt;body&gt;&lt;div class=&quot;parsed-wiki-content&quot;&gt;&lt;p&gt;&lt;&amp;&gt;&lt;/p&gt;&lt;/div&gt;&lt;/body&gt;&lt;/html&gt;

Modified: trunk/fellowiki/wiki/parser.py
===================================================================
--- trunk/fellowiki/wiki/parser.py	2006-03-12 11:51:39 UTC (rev 6)
+++ trunk/fellowiki/wiki/parser.py	2006-03-18 15:52:44 UTC (rev 7)
@@ -94,6 +94,7 @@
             if self.close_matching(res):
                 tokens.insert(0, self.close(res, new_token))
                 return
+            # TODO: is
             else:
                 new_token.prepend_element_contents(res.render())
                 
@@ -131,7 +132,7 @@
         xhtml.text = re.sub('[ \n\t]+', ' ', self.text)
         return xhtml
 
-class EmbeddedTextToken(Token):
+class BetweenParagraphsToken(Token):
     def render(self):
         xhtml = Element('div')
         new_token = SubElement(xhtml, self.html_tag)
@@ -163,7 +164,7 @@
 #                markers[self.input_marker+'~_'] = True
         if self.type == ')':
             self.second_content = None
-        Token.evaluate(result, tokens, new_token)
+        Token.evaluate(self, result, tokens, new_token)
         
     def match_is_open(self):
         if self.type == ')':
@@ -212,7 +213,7 @@
     special_markup = {'/': ('em', 'italic'),
                             '*': ('b', 'bold'),
                             '_': ('em', 'underline'),
-                            '=': ('tt', 'typewriter'),
+                            '=': ('tt', 'typewriter'), 
                             &quot;'&quot;: ('div', 'single_quotes'),
                             '&quot;': ('div', 'double_quotes'),
                             '^': ('div', 'superscript'),
@@ -250,43 +251,42 @@
             else:
                 self.type = '('
             
-        EncapsulateMarkupToken.evaluate(result, tokens, new_token)
+        EncapsulateMarkupToken.evaluate(self, result, tokens, new_token)
+    def do_close(self,match, new_token, second_content): 
+        self.content = new_token.xhtml # TODO: this is only a DEBUG fix
 
-class StructureToken(Token):
-    ## all Structure is equal and should be of preference 0
-    open_structure_list = []
+class ParagraphToken(Token):
     def __init__(self, token, *args, **kwargs):
         Token.__init__(self, token, *args, **kwargs)
         self.xhtml = Element('div')
 
     def evaluate(self, result, tokens, new_token):
         Token.evaluate(self, result, tokens, new_token)
-        if not self.match_is_open:
-            self.open_structure_list.append(self.html_tag)
         
     def match_is_open(self):
-        try:
-            self.open_structure_list.index(self.html_tag)
-            return True
-        except ValueError:
-            return False
+        return True
     
     def close_matching(self, match):
         return     isinstance(self, match.__class__) \
                  or isinstance(match, self.__class__)
             
     def close(self, match, new_token):
-        new_token.xhtml.tag = self.html_tag
-        match.xhtml.append(new_token.xhtml)
-        while len(self.open_structure_list) &gt; 0:
-            if self.open_structure_list.pop() == self.html_tag: 
-                break
+        if len(new_token.xhtml) != 0 or new_token.xhtml.text is not None \
+                                     or new_token.xhtml.tail is not None:
+           new_token.xhtml.tag = 'p'
+           match.xhtml.append(new_token.xhtml)
         return match
         
     def render(self):
         return self.xhtml
             
 
+class BetweenParagraphsToken(ParagraphToken):
+    def close(self, match, new_token):
+        match_ = ParagraphToken.close(self, match, new_token)
+        embed = SubElement(match_.xhtml, self.html_tag)
+        embed.text = self.text
+        return match_
 
 class StructureModifyToken(Token): 
 #modifiziert letzte geoeffnete struktur, wird dann wegfallen lassen =&gt; keine
@@ -302,15 +302,17 @@
     pass
 class HeadlineToken(PrefixToken): 
     pass
-class ListToken(EncapsulateToken): 
+    
+    
+class ListToken(PrefixToken): 
     pass
-class LinkToken(EncapsulateToken): 
+class LinkToken(Token): 
     pass
 class EmbeddedLinkToken(LinkToken): 
     pass
 class MacroToken(LinkToken): 
     pass
-class TableToken(EncapsulateToken): 
+class TableToken(Token): 
     pass
 
 def token_factory(token_cls, *args, **kw_args):
@@ -325,7 +327,7 @@
                      cut_right=2, decode_backslash = True)),
               # escaped text, preformatted:
               (10, r'\[@([^\\@\[]|\\.|@[^\\\]])*@\]', 
-                     token_factory(EmbeddedTextToken,
+                     token_factory(BetweenParagraphsToken,
                      preference = 0, html_tag='pre',
                      cut_left=2, cut_right=2, 
                      decode_backslash = True)),
@@ -335,8 +337,8 @@
               (20, r'([ \n\t]*\n%%%%%*[ \n\t]*)+\n',
                      token_factory(SingleToken, preference=10, html_tag='br')),
               # paragraph break
-              (30, r'\n[ \n\t]*\n', token_factory(StructureToken,
-                     preference = 0, html_tag='p')),
+              (30, r'\n[ \n\t]*\n', token_factory(ParagraphToken,
+                     preference = 0)),
               # line break in input (non-printable)
               (40, r'\n', token_factory(TextToken, preference=20)),
               # include link start
@@ -363,7 +365,7 @@
               (10, r'&lt;[:()^,]&gt;', token_factory(StructureModifyToken, 
                     cut_left=1, cut_right=1)),
               # headlines
-              (10, r'\n={1,6}[ \t]', token_factory(HeadlineToken, 
+              (10, r'^={1,6}[ \t]', token_factory(HeadlineToken, 
                     preference=10)),
               # lists
               (10, r'\n[#*-]+[ \t]', token_factory(ListToken, preference=10)),
@@ -390,7 +392,7 @@
         regexes = self.regexes[:]
         regexes.sort()
         regexes = [(rex, callback) for (_, rex, callback) in regexes]
-        self.scanner = sre.Scanner(regexes)
+        self.scanner = sre.Scanner(regexes, sre.M)
 
     def parse(self, text):
         tokens = self.scanner.scan(''.join(['\n\n', text, '\n\n']))


</PRE>

<!--endarticle-->
    <HR>
    <P><UL>
        <!--threads-->
	<LI>Previous message: <A HREF="000004.html">[fellowiki-svncheckins] r6 - trunk/fellowiki/tests/wiki
</A></li>
	<LI>Next message: <A HREF="000006.html">[fellowiki-svncheckins] r8 - in trunk/fellowiki: tests/wiki/tests/simple_markup wiki
</A></li>
         <LI> <B>Messages sorted by:</B> 
              <a href="date.html#5">[ date ]</a>
              <a href="thread.html#5">[ thread ]</a>
              <a href="subject.html#5">[ subject ]</a>
              <a href="author.html#5">[ author ]</a>
         </LI>
       </UL>

<hr>
<a href="https://lists.berlios.de/mailman/listinfo/fellowiki-svncheckins">More information about the fellowiki-svncheckins
mailing list</a><br>
</body></html>
